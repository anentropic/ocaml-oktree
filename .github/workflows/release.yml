name: Release

on:
  workflow_run:
    workflows: ["CI"]
    branches: [main]
    types: 
      - completed


permissions:
  contents: write

jobs:
  # TODO: should release be when tag is pushed instead of all pushes to main?
  release:
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    runs-on: ubuntu-latest
    steps:
      # Checkout the exact commit that passed CI, including all history and tags
      # for version comparison
      - name: Checkout
        uses: actions/checkout@v6
        with:
          fetch-depth: 0
          ref: ${{ github.event.workflow_run.head_sha }}

      # Extract the current package version from the .opam file
      # This is the source of truth for the version that will be released
      - name: Extract version
        id: version
        run: |
          version=$(grep -E '^version:' oktree.opam | head -n1 | sed -E 's/^version: "([^"]+)".*/\1/')
          if [ -z "$version" ]; then
            echo "Version not found in oktree.opam" >&2
            exit 1
          fi
          echo "version=$version" >> "$GITHUB_OUTPUT"

      # Determine if a release is needed by comparing the current version against
      # the latest v* tag.
      # - Release if no prior tag exists.
      # - Release if version is greater than latest tag (normal release).
      # - If version matches latest tag, release only when that package version
      #   is not yet present in ocaml/opam-repository (amended release).
      - name: Check release required
        id: release_check
        run: |
          current_version="${{ steps.version.outputs.version }}"
          latest_tag=$(git tag -l 'v*' --sort=-v:refname | head -n1)
          if [ -z "$latest_tag" ]; then
            echo "release=true" >> "$GITHUB_OUTPUT"
            echo "reason=no prior tag" >> "$GITHUB_OUTPUT"
            exit 0
          fi

          latest_version="${latest_tag#v}"
          if dpkg --compare-versions "$current_version" gt "$latest_version"; then
            echo "release=true" >> "$GITHUB_OUTPUT"
            echo "reason=version bump" >> "$GITHUB_OUTPUT"
          elif dpkg --compare-versions "$current_version" eq "$latest_version"; then
            opam_pkg_url="https://raw.githubusercontent.com/ocaml/opam-repository/master/packages/oktree/oktree.${current_version}/opam"
            if curl -fsSL "$opam_pkg_url" >/dev/null; then
              echo "release=false" >> "$GITHUB_OUTPUT"
              echo "reason=already published in opam-repository" >> "$GITHUB_OUTPUT"
            else
              echo "release=true" >> "$GITHUB_OUTPUT"
              echo "reason=amended release" >> "$GITHUB_OUTPUT"
            fi
          else
            echo "release=false" >> "$GITHUB_OUTPUT"
            echo "reason=no version bump" >> "$GITHUB_OUTPUT"
          fi

      # Log release decision for easier debugging/auditing in workflow output
      - name: Decision summary
        run: |
          echo "release=${{ steps.release_check.outputs.release }}"
          echo "reason=${{ steps.release_check.outputs.reason }}"
          echo "version=${{ steps.version.outputs.version }}"

      # Create/update and push a git tag for the version (e.g., v1.2.3)
      - name: Create tag
        if: steps.release_check.outputs.release == 'true'
        run: |
          git tag -f "v${{ steps.version.outputs.version }}"
          git push --force origin "refs/tags/v${{ steps.version.outputs.version }}"

      # Create a GitHub release with auto-generated release notes from commits
      - name: Create GitHub Release
        if: steps.release_check.outputs.release == 'true'
        uses: softprops/action-gh-release@v2
        with:
          tag_name: "v${{ steps.version.outputs.version }}"
          generate_release_notes: true

      # Set up OCaml environment with compiler version 5 for opam-publish
      - name: Set up OCaml
        if: steps.release_check.outputs.release == 'true'
        uses: ocaml/setup-ocaml@v3
        with:
          ocaml-compiler: 5

      # Install the opam-publish tool used to submit packages to opam-repository
      - name: Install opam-publish
        if: steps.release_check.outputs.release == 'true'
        run: opam install opam-publish --yes

      # Submit a pull request to ocaml/opam-repository to publish the package
      # Uses a separate GitHub token with permissions to create PRs in external repos
      - name: Publish to opam-repository
        if: steps.release_check.outputs.release == 'true'
        env:
          OPAM_PUBLISH_GH_TOKEN: ${{ secrets.OPAM_PUBLISH_GH_TOKEN }}
        run: |
          opam exec -- opam-publish \
            --no-confirmation \
            --no-browser \
            --tag "v${{ steps.version.outputs.version }}" \
            --repo ocaml/opam-repository \
            .
